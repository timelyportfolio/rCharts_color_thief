<!DOCTYPE html>
<!--
help from
  http://stackoverflow.com/questions/6735470/get-pixel-color-from-canvas-on-mouseover
  http://bl.ocks.org/jinroh/4666920
  https://github.com/dtao/nearest-color
-->

<meta charset="utf-8">

<head>
  <script src = "http://d3js.org/d3.v3.js"></script>
  <script src = "js/nearestColor.js"></script>
  <style>
    /* styling from http://bl.ocks.org/jinroh/4666920 */
    canvas {
      padding: 0;
      margin: 0;
    }
    svg {
      position: absolute;
      top: 0;
      bottom: 0;
    }
    .brush .extent {
      fill-opacity: .3;
      shape-rendering: crispEdges;
    }
    .resize rect {
      visibility: visible !important;
      fill: #333;
      fill-opacity: .8;
      stroke: #555;
      stroke-width: 1.5px;
    }    
  </style>
</head>

<body>

  <div id = "canvas-div">
    <svg id = "overlay"></svg>
    <canvas id = "canvas-image"></canvas>
  </div>
  
</body>

<script>

  var canvasDiv = document.getElementById("canvas-div")
  var svg = d3.select("#overlay").append("g")
  var canvas = document.getElementById("canvas-image")

  var context;
  var width;
  var height;
  
  var brush, brushsize, x, y;
  
  var colorScale = d3.scale.linear()
        .domain([0,1]);
  var colorRef;
        
  var nearest;
  
  //load image and draw on canvas
  imageObj = new Image();
  imageObj.onload = function() {
    initCanvas( );
  }
  imageObj.src = "img/heatmap.png"

  function initCanvas() {
    
    if(context) context.clearRect(0,0,width,height);
    
    width = imageObj.width;
    height = imageObj.height; 
    
    canvasDiv.style.width = width + "px"
    canvasDiv.style.height = height + "px"
    
    canvas.width = width;
    canvas.height = height;
    
    d3.select(svg.node().parentNode).attr("height", canvasDiv.style.height);
    d3.select(svg.node().parentNode).attr("width", canvasDiv.style.width)

    context = canvas.getContext("2d");    
      
    context.setTransform(1, 0, 0, 1, 0, 0);;
    
    draw();
    
    setupBrush();
  }
    
  
  function draw( ) {
    context.clearRect(0,0,width,height);
    context.drawImage(imageObj, 0, 0, width, height);
  }
  
  function setupBrush( ){
     brushsize = 6
     x = d3.scale.linear().range([0, width]);
     y = d3.scale.linear().range([height, 0]);

    brush = d3.svg.brush()
      .x(x)
      .y(y)
      .extent([[.4, .4],[.6, .6]])
      .on("brushend", brushend);
      
    svg.append("g")
        .attr("class", "brush")
        .call(brush);       
      
  }
  
  function brushend() {
    updateColorScale(brush.extent());
  }
  
  // update color scale to newly brushed area
  //  for now assume scale is horizontal
  function updateColorScale( extent ){
   var pos = findPos(canvas);
   
   colorRef = {};
    
    var x0 = x(extent[0][0]);
    var x1 = x(extent[1][0]);
    var ymid = (y(extent[0][1]) + y(extent[1][1]))/2 - brushsize;
    console.log(ymid)
    var colorRange = [];
    var colorDomain = [];
    //arbitrarily pick 1000 spots on the range
    for(i = 0; i < 1000; i++){
      x = (x1 - x0)/1000 * i + x0
      p = context.getImageData(x, ymid, 1, 1).data; 
      hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
      colorDomain.push(i/1000);
      colorRange.push(hex);
    }
    colorScale.range(colorRange).domain(colorDomain);
    
    colorRange.map(function(d,i){
      colorRef[d] = colorDomain[i];
    })
    
    nearest = nearestColor.from( colorRange );
  }
  
  //  code from http://stackoverflow.com/questions/6735470/get-pixel-color-from-canvas-on-mouseover
  
  function findPos(obj) {
      var curleft = 0, curtop = 0;
      if (obj.offsetParent) {
          do {
              curleft += obj.offsetLeft;
              curtop += obj.offsetTop;
          } while (obj = obj.offsetParent);
          return { x: curleft, y: curtop };
      }
      return undefined;
  }
  
  function rgbToHex(r, g, b) {
      if (r > 255 || g > 255 || b > 255)
          throw "Invalid color component";
      return ((r << 16) | (g << 8) | b).toString(16);
  }
  
  
  svg.on("mousemove", function() {
      var pos = findPos(canvas);
      var x = d3.event.pageX - pos.x;
      var y = d3.event.pageY - pos.y;
      var coord = "x=" + x + ", y=" + y;
      var p = context.getImageData(x, y, 1, 1).data; 
      var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
      console.log([coord,hex].join(" "));
      console.log([nearest(hex),colorRef[nearest(hex)]].join(":"))
  });

</script>
